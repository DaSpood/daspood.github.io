(function(){"use strict";const y=(r,n)=>{const t=Object.keys(r.lootboxPendingCounters);let e=n&&t.includes(n)?t.findIndex(o=>o===n):0;for(e>0&&r.lootboxPendingCounters[t[e]]===0&&(e=0);e<t.length;){if(r.lootboxPendingCounters[t[e]]>0)return t[e];e++}return null},c=(r,n)=>r.lootSlots.map(t=>{if(t.contentType===n)return{slot:t,group:void 0};if(!t.contentType){const e=t.lootGroups.map(o=>o.contentType===n?o:void 0).filter(o=>!!o).pop()??void 0;if(e)return{slot:t,group:e}}return{slot:void 0,group:void 0}}).filter(t=>!!t.slot).pop(),m=r=>{const n=[r[0].dropRate];for(let e=1;e<r.length;e++)n[e]=r[e].dropRate+n[e-1];const t=Math.random();for(let e=0;e<n.length;e++)if(n[e]>t)return r[e];return r[r.length-1]},R=(r,n)=>r+r/(1-n)*n,f=(r,n,t)=>r-r/(1-t)*n,g=(r,n,t)=>{const e=c(t,"main"),o=c(n,"main");if(n.mainPrizeHardPity&&r.pityCounters[t.name].mainPity>=n.mainPrizeHardPity)e.group?e.slot.lootGroups.forEach(l=>l.dropRate=l.contentType==="main"?1:0):e.slot.dropRate=1;else if(n.mainPrizeSoftPity&&r.pityCounters[t.name].mainPity>=n.mainPrizeSoftPity)if(e.group){const l=(1-o.group.dropRate)/(n.mainPrizeHardPity-n.mainPrizeSoftPity),p=e.group.dropRate;e.slot.lootGroups.forEach(d=>d.dropRate=d.contentType==="main"?d.dropRate+l:f(d.dropRate,l,p))}else e.slot.dropRate+=(1-o.slot.dropRate)/(n.mainPrizeHardPity-n.mainPrizeSoftPity);const a=c(t,"secondary"),i=c(n,"secondary");if(!(!a||!i)){if(n.secondaryPrizeHardPity&&r.pityCounters[t.name].secondaryPity>=n.secondaryPrizeHardPity)(JSON.stringify(a.slot)!==JSON.stringify(e.slot)||r.pityCounters[t.name].mainPity===n.mainPrizeHardPity)&&(a.group?a.slot.lootGroups.forEach(l=>l.dropRate=l.contentType==="secondary"?1:0):a.slot.dropRate=1);else if(n.secondaryPrizeSoftPity&&r.pityCounters[t.name].secondaryPity>=n.secondaryPrizeSoftPity)if(a.group){const l=(1-i.group.dropRate)/(n.secondaryPrizeHardPity-n.secondaryPrizeSoftPity),p=a.group.dropRate;a.slot.lootGroups.forEach(d=>d.dropRate=d.contentType==="secondary"?d.dropRate+l:f(d.dropRate,l,p))}else a.slot.dropRate+=(1-i.slot.dropRate)/(n.secondaryPrizeHardPity-n.secondaryPrizeSoftPity)}},T=(r,n,t,e)=>{if(r.pityCounters[t.name].mainPity++,e.drops.find(o=>o.lootTableBranch.type==="main")){r.pityCounters[t.name].mainPity=1;const o=c(t,"main"),a=c(n,"main");if(o.group)for(let i=0;i<o.slot.lootGroups.length;i++)o.slot.lootGroups[i].dropRate=a.slot.lootGroups[i].dropRate;else o.slot.dropRate=a.slot.dropRate}if(r.pityCounters[t.name].secondaryPity++,e.drops.find(o=>o.lootTableBranch.type==="secondary")){r.pityCounters[t.name].secondaryPity=1;const o=c(t,"secondary"),a=c(n,"secondary");if(o.group)for(let i=0;i<o.slot.lootGroups.length;i++)o.slot.lootGroups[i].dropRate=a.slot.lootGroups[i].dropRate;else o.slot.dropRate=a.slot.dropRate}},D=(r,n)=>{const t=n.lootDrops.find(e=>e.name===r);t.name=t.substitute.name,t.displayPriority=t.substitute.displayPriority??0,t.pictureUrl=t.substitute.pictureUrl,t.overrideRarityInUi=t.substitute.overrideRarityInUi,t.amount=t.substitute.amount;for(const e of n.lootDrops)if(e.name!==e.substitute.name||e.displayPriority!==t.substitute.displayPriority||e.pictureUrl!==e.substitute.pictureUrl||e.overrideRarityInUi!==e.substitute.overrideRarityInUi||e.amount!==e.substitute.amount)return"replace_individual";return"allowed"},v=(r,n,t)=>{const e=n.lootDrops.find(o=>o.name===r);e.name=t.name,e.displayPriority=t.displayPriority??0,e.pictureUrl=t.pictureUrl,e.overrideRarityInUi=t.overrideRarityInUi,e.amount=t.amount;for(const o of n.lootDrops)if(o.name!==t.name||o.displayPriority!==t.displayPriority||o.pictureUrl!==t.pictureUrl||o.overrideRarityInUi!==t.overrideRarityInUi||o.amount!==t.amount)return"replace_all";return"allowed"},z=(r,n,t,e)=>{const o=t.lootDrops.find(i=>i.name===r),a=[];return t.lootDrops.forEach(i=>{i.name!==r&&a.push(i)}),a.forEach(i=>{i.dropRate=R(i.dropRate,o.dropRate)}),a.length?(t.lootDrops=a,"remove"):(n.lootDrops.forEach(i=>{const l=JSON.parse(JSON.stringify(i));l.name=e?e.name:l.substitute.name,l.displayPriority=e?e.displayPriority??0:l.substitute.displayPriority??0,l.pictureUrl=e?e.pictureUrl:l.substitute.pictureUrl,l.overrideRarityInUi=e?e.overrideRarityInUi:l.substitute.overrideRarityInUi,l.amount=e?e.amount:l.substitute.amount,a.push(l),t.lootDrops=a}),"allowed")},P=(r,n,t,e,o)=>{switch(e){case"replace_individual":return D(r,t);case"replace_all":return v(r,t,o);case"remove":return z(r,n,t,o);case"allowed":default:return"allowed"}},U=r=>{if(!r)return[];const n=[];return r.lootSlots.forEach(t=>{if(t.dropRate<=Math.random())return;const e=m(t.lootGroups),o=m(e.lootDrops),a=t.contentType==="main"?r.mainPrizeDuplicates:t.contentType==="secondary"?r.secondaryPrizeDuplicates:"allowed";n.push({amount:o.amount,rarityInUi:o.overrideRarityInUi||(t.contentType??e.contentType),lootTableBranch:{drop:o,parentGroup:e,parentSlot:t,parentBox:r,type:t.contentType??e.contentType,priority:o.displayPriority??0,isSubjectToDuplicationRules:a!=="allowed",parentDrop:void 0,isSubstitute:!1}})}),n},h=(r,n)=>{const t=r.referenceLootTable.lootboxes.find(p=>p.name===n),e=r.dynamicLootTable.lootboxes.find(p=>p.name===n);g(r,t,e);const o=U(e),a={sessionOpeningNumber:r.history.length+1,boxName:e.name,boxOpeningNumber:r.lootboxOpenedCounters[e.name]+1,boxMainPity:r.pityCounters[e.name].mainPity,boxSecondaryPity:r.pityCounters[e.name].secondaryPity,drops:o};r.history.push(a),T(r,t,e,a),r.lootboxOpenedCounters[e.name]++,r.lootboxPendingCounters[e.name]--,o.forEach(p=>{r.aggregatedResults[p.lootTableBranch.drop.name]+=p.amount,Object.keys(r.lootboxPendingCounters).includes(p.lootTableBranch.drop.name)&&r.lootboxPendingCounters[p.lootTableBranch.drop.name]++});const i=a.drops.find(p=>p.lootTableBranch.type==="main");i&&(e.mainPrizeDuplicates=P(i.lootTableBranch.drop.name,r.referenceLootTableUniqueDrops[i.lootTableBranch.drop.name].parentGroup,i.lootTableBranch.parentGroup,e.mainPrizeDuplicates,e.mainPrizeSubstitute));const l=a.drops.find(p=>p.lootTableBranch.type==="secondary");if(l&&(e.secondaryPrizeDuplicates=P(l.lootTableBranch.drop.name,r.referenceLootTableUniqueDrops[l.lootTableBranch.drop.name].parentGroup,l.lootTableBranch.parentGroup,e.secondaryPrizeDuplicates,e.secondaryPrizeSubstitute)),r.referenceLootTable.autoOpenRecursive)for(const p of o)Object.keys(r.lootboxOpenedCounters).includes(p.lootTableBranch.drop.name)&&(r.history.pop(),a.drops=a.drops.filter(s=>JSON.stringify(s)!==JSON.stringify(p)),r=h(r,p.lootTableBranch.drop.name),r.history.pop().drops.forEach(s=>{a.drops.push(s)}),r.history.push(a));return r},O=r=>{let n=r,t=y(n);for(;t=y(n,t??void 0);)for(;n.lootboxPendingCounters[t]>0;)n=h(n,t);return n},S=r=>{if(!r.simulatorConfig.targetPrizes.length)return r;const n=r.simulatorConfig.preOwnedPrizes.map(a=>a.name),t=r.simulatorConfig.targetPrizes.map(a=>a.name).filter(a=>!n.includes(a)),e=r.referenceLootTable.lootboxes.find(a=>a.purchasable).name;let o=Object.entries(r.aggregatedResults).filter(([a,i])=>t.includes(a)&&i>0).length===t.length;for(;!o;)r.lootboxPurchasedCounters[e]++,r.lootboxPendingCounters[e]++,r=O(r),o=Object.entries(r.aggregatedResults).filter(([a,i])=>t.includes(a)&&i>0).length===t.length;return r},C=(r,n)=>{const t=[];for(let e=0;e<n;e++){const o=S(JSON.parse(r));t.push(Object.values(o.lootboxPurchasedCounters).find(a=>a>0)||0)}return t},u=globalThis;u.onmessage=r=>{const{rawInitialSession:n,iterations:t,workerId:e}=r.data;if(Object.keys(u).includes(`worker_${e}_working`))return;u[`worker_${e}_working`]=!0;const o=C(n,t);postMessage({workerId:e,result:o}),delete u[`worker_${e}_working`]}})();
