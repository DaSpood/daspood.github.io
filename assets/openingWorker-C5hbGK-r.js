(function(){"use strict";const y=(t,n)=>{const r=Object.keys(t.lootboxPendingCounters);let e=n&&r.includes(n)?r.findIndex(o=>o===n):0;for(e>0&&t.lootboxPendingCounters[r[e]]===0&&(e=0);e<r.length;){if(t.lootboxPendingCounters[r[e]]>0)return r[e];e++}return null},c=(t,n)=>t.lootSlots.map(r=>{if(r.contentType===n)return{slot:r,group:void 0};if(!r.contentType){const e=r.lootGroups.map(o=>o.contentType===n?o:void 0).filter(o=>!!o).pop()??void 0;if(e)return{slot:r,group:e}}return{slot:void 0,group:void 0}}).filter(r=>!!r.slot).pop(),m=t=>{const n=[t[0].dropRate];for(let e=1;e<t.length;e++)n[e]=t[e].dropRate+n[e-1];const r=Math.random();for(let e=0;e<n.length;e++)if(n[e]>r)return t[e];return t[t.length-1]},R=(t,n)=>t+t/(1-n)*n,f=(t,n,r)=>t-t/(1-r)*n,g=(t,n,r)=>{const e=c(r,"main"),o=c(n,"main");if(n.mainPrizeHardPity&&t.pityCounters[r.name].mainPity>=n.mainPrizeHardPity)e.group?e.slot.lootGroups.forEach(l=>l.dropRate=l.contentType==="main"?1:0):e.slot.dropRate=1;else if(n.mainPrizeSoftPity&&t.pityCounters[r.name].mainPity>=n.mainPrizeSoftPity)if(e.group){const l=(1-o.group.dropRate)/(n.mainPrizeHardPity-n.mainPrizeSoftPity),p=e.group.dropRate;e.slot.lootGroups.forEach(d=>d.dropRate=d.contentType==="main"?d.dropRate+l:f(d.dropRate,l,p))}else e.slot.dropRate+=(1-o.slot.dropRate)/(n.mainPrizeHardPity-n.mainPrizeSoftPity);const a=c(r,"secondary"),i=c(n,"secondary");if(!(!a||!i)){if(n.secondaryPrizeHardPity&&t.pityCounters[r.name].secondaryPity>=n.secondaryPrizeHardPity)(JSON.stringify(a.slot)!==JSON.stringify(e.slot)||t.pityCounters[r.name].mainPity===n.mainPrizeHardPity)&&(a.group?a.slot.lootGroups.forEach(l=>l.dropRate=l.contentType==="secondary"?1:0):a.slot.dropRate=1);else if(n.secondaryPrizeSoftPity&&t.pityCounters[r.name].secondaryPity>=n.secondaryPrizeSoftPity)if(a.group){const l=(1-i.group.dropRate)/(n.secondaryPrizeHardPity-n.secondaryPrizeSoftPity),p=a.group.dropRate;a.slot.lootGroups.forEach(d=>d.dropRate=d.contentType==="secondary"?d.dropRate+l:f(d.dropRate,l,p))}else a.slot.dropRate+=(1-i.slot.dropRate)/(n.secondaryPrizeHardPity-n.secondaryPrizeSoftPity)}},T=(t,n,r,e)=>{if(t.pityCounters[r.name].mainPity++,e.drops.find(o=>o.lootTableBranch.type==="main")){t.pityCounters[r.name].mainPity=1;const o=c(r,"main"),a=c(n,"main");if(o.group)for(let i=0;i<o.slot.lootGroups.length;i++)o.slot.lootGroups[i].dropRate=a.slot.lootGroups[i].dropRate;else o.slot.dropRate=a.slot.dropRate}if(t.pityCounters[r.name].secondaryPity++,e.drops.find(o=>o.lootTableBranch.type==="secondary")){t.pityCounters[r.name].secondaryPity=1;const o=c(r,"secondary"),a=c(n,"secondary");if(o.group)for(let i=0;i<o.slot.lootGroups.length;i++)o.slot.lootGroups[i].dropRate=a.slot.lootGroups[i].dropRate;else o.slot.dropRate=a.slot.dropRate}},D=(t,n)=>{const r=n.lootDrops.find(e=>e.name===t);r.name=r.substitute.name,r.displayPriority=r.substitute.displayPriority??0,r.pictureUrl=r.substitute.pictureUrl,r.overrideRarityInUi=r.substitute.overrideRarityInUi,r.amount=r.substitute.amount;for(const e of n.lootDrops)if(e.name!==e.substitute.name||e.displayPriority!==r.substitute.displayPriority||e.pictureUrl!==e.substitute.pictureUrl||e.overrideRarityInUi!==e.substitute.overrideRarityInUi||e.amount!==e.substitute.amount)return"replace_individual";return"allowed"},v=(t,n,r)=>{const e=n.lootDrops.find(o=>o.name===t);e.name=r.name,e.displayPriority=r.displayPriority??0,e.pictureUrl=r.pictureUrl,e.overrideRarityInUi=r.overrideRarityInUi,e.amount=r.amount;for(const o of n.lootDrops)if(o.name!==r.name||o.displayPriority!==r.displayPriority||o.pictureUrl!==r.pictureUrl||o.overrideRarityInUi!==r.overrideRarityInUi||o.amount!==r.amount)return"replace_all";return"allowed"},z=(t,n,r,e)=>{const o=r.lootDrops.find(i=>i.name===t),a=[];return r.lootDrops.forEach(i=>{i.name!==t&&a.push(i)}),a.forEach(i=>{i.dropRate=R(i.dropRate,o.dropRate)}),a.length?(r.lootDrops=a,"remove"):(n.lootDrops.forEach(i=>{const l=JSON.parse(JSON.stringify(i));l.name=e?e.name:l.substitute.name,l.displayPriority=e?e.displayPriority??0:l.substitute.displayPriority??0,l.pictureUrl=e?e.pictureUrl:l.substitute.pictureUrl,l.overrideRarityInUi=e?e.overrideRarityInUi:l.substitute.overrideRarityInUi,l.amount=e?e.amount:l.substitute.amount,a.push(l),r.lootDrops=a}),"allowed")},P=(t,n,r,e,o)=>{switch(e){case"replace_individual":return D(t,r);case"replace_all":return v(t,r,o);case"remove":return z(t,n,r,o);case"allowed":default:return"allowed"}},U=t=>{if(!t)return[];const n=[];return t.lootSlots.forEach(r=>{if(r.dropRate<=Math.random())return;const e=m(r.lootGroups),o=m(e.lootDrops),a=r.contentType==="main"?t.mainPrizeDuplicates:r.contentType==="secondary"?t.secondaryPrizeDuplicates:"allowed";n.push({amount:o.amount,rarityInUi:o.overrideRarityInUi||(r.contentType??e.contentType),lootTableBranch:{drop:o,parentGroup:e,parentSlot:r,parentBox:t,type:r.contentType??e.contentType,priority:o.displayPriority??0,isSubjectToDuplicationRules:a!=="allowed",parentDrop:void 0,isSubstitute:!1}})}),n},h=(t,n)=>{const r=t.referenceLootTable.lootboxes.find(p=>p.name===n),e=t.dynamicLootTable.lootboxes.find(p=>p.name===n);g(t,r,e);const o=U(e),a={sessionOpeningNumber:t.history.length+1,boxName:e.name,boxOpeningNumber:t.lootboxOpenedCounters[e.name]+1,boxMainPity:t.pityCounters[e.name].mainPity,boxSecondaryPity:t.pityCounters[e.name].secondaryPity,drops:o};t.history.push(a),T(t,r,e,a),t.lootboxOpenedCounters[e.name]++,t.lootboxPendingCounters[e.name]--,o.forEach(p=>{t.aggregatedResults[p.lootTableBranch.drop.name]+=p.amount,Object.keys(t.lootboxPendingCounters).includes(p.lootTableBranch.drop.name)&&t.lootboxPendingCounters[p.lootTableBranch.drop.name]++});const i=a.drops.find(p=>p.lootTableBranch.type==="main");i&&(e.mainPrizeDuplicates=P(i.lootTableBranch.drop.name,t.referenceLootTableUniqueDrops[i.lootTableBranch.drop.name].parentGroup,i.lootTableBranch.parentGroup,e.mainPrizeDuplicates,e.mainPrizeSubstitute));const l=a.drops.find(p=>p.lootTableBranch.type==="secondary");if(l&&(e.secondaryPrizeDuplicates=P(l.lootTableBranch.drop.name,t.referenceLootTableUniqueDrops[l.lootTableBranch.drop.name].parentGroup,l.lootTableBranch.parentGroup,e.secondaryPrizeDuplicates,e.secondaryPrizeSubstitute)),t.referenceLootTable.autoOpenRecursive)for(const p of o)Object.keys(t.lootboxOpenedCounters).includes(p.lootTableBranch.drop.name)&&(t.history.pop(),a.drops=a.drops.filter(s=>JSON.stringify(s)!==JSON.stringify(p)),t=h(t,p.lootTableBranch.drop.name),t.history.pop().drops.forEach(s=>{a.drops.push(s)}),t.history.push(a));return t},S=t=>{let n=t,r=y(n);for(;r=y(n,r??void 0);)for(;n.lootboxPendingCounters[r]>0;)n=h(n,r);return n},G=t=>{if(!t.simulatorConfig.targetPrizes.length)return t;const n=t.simulatorConfig.targetPrizes.map(o=>o.name),r=t.referenceLootTable.lootboxes.find(o=>o.purchasable).name;let e=Object.entries(t.aggregatedResults).filter(([o,a])=>n.includes(o)&&a>0).length===n.length;for(;!e;)t.lootboxPurchasedCounters[r]++,t.lootboxPendingCounters[r]++,t=S(t),e=Object.entries(t.aggregatedResults).filter(([o,a])=>n.includes(o)&&a>0).length===n.length;return t},C=(t,n)=>{const r=[];for(let e=0;e<n;e++){const o=G(JSON.parse(t));r.push(Object.values(o.lootboxPurchasedCounters).find(a=>a>0)||0)}return r},u=globalThis;u.onmessage=t=>{const{rawInitialSession:n,iterations:r,workerId:e}=t.data;if(Object.keys(u).includes(`worker_${e}_working`))return;u[`worker_${e}_working`]=!0;const o=C(n,r);postMessage({workerId:e,result:o}),delete u[`worker_${e}_working`]}})();
